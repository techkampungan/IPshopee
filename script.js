// Data wilayah administratif Kabupaten Sidoarjo dengan koordinat yang lebih akuratn
const sidoarjoData = {
    "Tanggulangin": [
        { name: "Kludan", lat: -7.4981, lng: 112.6989 },
        { name: "Ngaban", lat: -7.5012, lng: 112.7023 },
        { name: "Kedungpeluk", lat: -7.4945, lng: 112.7056 },
        { name: "Bluru Kidul", lat: -7.5089, lng: 112.7134 },
        { name: "Tanggulangin", lat: -7.5156, lng: 112.7089 },
        { name: "Kalanganyar", lat: -7.5234, lng: 112.7167 },
        { name: "Kemasan", lat: -7.5178, lng: 112.6945 },
        { name: "Gelam", lat: -7.5089, lng: 112.6823 },
        { name: "Ketegan", lat: -7.4967, lng: 112.6756 },
        { name: "Banjarpanji", lat: -7.4823, lng: 112.6934 }
    ],
    "Sidoarjo": [
        { name: "Lebo", lat: -7.4389, lng: 112.7178 },
        { name: "Celep", lat: -7.4456, lng: 112.7234 },
        { name: "Sidokumpul", lat: -7.4512, lng: 112.7289 },
        { name: "Magersari", lat: -7.4234, lng: 112.7345 },
        { name: "Pucanganom", lat: -7.4345, lng: 112.7456 },
        { name: "Lemahputro", lat: -7.4567, lng: 112.7123 },
        { name: "Gebang", lat: -7.4678, lng: 112.7234 },
        { name: "Sekardangan", lat: -7.4789, lng: 112.7345 }
    ],
    "Krembung": [
        { name: "Krembung", lat: -7.2234, lng: 112.6789 },
        { name: "Kedungboto", lat: -7.2345, lng: 112.6856 },
        { name: "Tenggulunan", lat: -7.2456, lng: 112.6923 },
        { name: "Mojorangagung", lat: -7.2567, lng: 112.6990 },
        { name: "Semambung", lat: -7.2678, lng: 112.7057 },
        { name: "Kemuning", lat: -7.2789, lng: 112.7124 },
        { name: "Kebaron", lat: -7.2890, lng: 112.7191 },
        { name: "Eplak", lat: -7.2901, lng: 112.7258 }
    ],
    "Waru": [
        { name: "Waru", lat: -7.3567, lng: 112.7234 },
        { name: "Jemundo", lat: -7.3678, lng: 112.7301 },
        { name: "Wedoro", lat: -7.3789, lng: 112.7368 },
        { name: "Medaeng", lat: -7.3890, lng: 112.7435 },
        { name: "Ngingas", lat: -7.3456, lng: 112.7502 },
        { name: "Tambak Sawah", lat: -7.3567, lng: 112.7569 },
        { name: "Kureksari", lat: -7.3678, lng: 112.7636 },
        { name: "Kepuh Kiriman", lat: -7.3789, lng: 112.7703 }
    ],
    "Taman": [
        { name: "Taman", lat: -7.3890, lng: 112.6456 },
        { name: "Sepanjang", lat: -7.3456, lng: 112.6523 },
        { name: "Kemiri", lat: -7.3567, lng: 112.6590 },
        { name: "Kletek", lat: -7.3678, lng: 112.6657 },
        { name: "Ngelom", lat: -7.3789, lng: 112.6724 },
        { name: "Pondok Tjandra Indah", lat: -7.3890, lng: 112.6791 },
        { name: "Wage", lat: -7.3456, lng: 112.6858 },
        { name: "Jemundo", lat: -7.3567, lng: 112.6925 }
    ],
    "Sukodono": [
        { name: "Sukodono", lat: -7.4567, lng: 112.6789 },
        { name: "Pucang Anom", lat: -7.4678, lng: 112.6856 },
        { name: "Gelam", lat: -7.4789, lng: 112.6923 },
        { name: "Candi", lat: -7.4890, lng: 112.6990 },
        { name: "Bakalan", lat: -7.4456, lng: 112.7057 },
        { name: "Jeruksari", lat: -7.4567, lng: 112.7124 },
        { name: "Kedungturi", lat: -7.4678, lng: 112.7191 },
        { name: "Plumbon", lat: -7.4789, lng: 112.7258 }
    ],
    "Buduran": [
        { name: "Buduran", lat: -7.4890, lng: 112.7456 },
        { name: "Siwalanpanji", lat: -7.4456, lng: 112.7523 },
        { name: "Siwalan Kerto", lat: -7.4567, lng: 112.7590 },
        { name: "Bringinan", lat: -7.4678, lng: 112.7657 },
        { name: "Prasung", lat: -7.4789, lng: 112.7724 },
        { name: "Sawohan", lat: -7.4890, lng: 112.7791 },
        { name: "Entalsewu", lat: -7.4456, lng: 112.7858 },
        { name: "Niwet", lat: -7.4567, lng: 112.7925 }
    ],
    "Sedati": [
        { name: "Sedati", lat: -7.4678, lng: 112.7992 },
        { name: "Betro", lat: -7.4789, lng: 112.8059 },
        { name: "Buncitan", lat: -7.4890, lng: 112.8126 },
        { name: "Pulungan", lat: -7.4456, lng: 112.8193 },
        { name: "Pabean", lat: -7.4567, lng: 112.8260 },
        { name: "Pranti", lat: -7.4678, lng: 112.8327 },
        { name: "Kalanganyar", lat: -7.4789, lng: 112.8394 },
        { name: "Tambak Cemandi", lat: -7.4890, lng: 112.8461 }
    ],
    "Gedangan": [
        { name: "Gedangan", lat: -7.4456, lng: 112.7234 },
        { name: "Ketajen", lat: -7.4567, lng: 112.7301 },
        { name: "Bungurasih", lat: -7.4678, lng: 112.7368 },
        { name: "Kemiri", lat: -7.4789, lng: 112.7435 },
        { name: "Sawotratap", lat: -7.4890, lng: 112.7502 },
        { name: "Tebel", lat: -7.4456, lng: 112.7569 },
        { name: "Banjarkemuning", lat: -7.4567, lng: 112.7636 },
        { name: "Wedoro", lat: -7.4678, lng: 112.7703 }
    ],
    "Wonoayu": [
        { name: "Wonoayu", lat: -7.3678, lng: 112.5456 },
        { name: "Candinegoro", lat: -7.3789, lng: 112.5523 },
        { name: "Krian", lat: -7.3890, lng: 112.5590 },
        { name: "Mojoagung", lat: -7.3456, lng: 112.5657 },
        { name: "Sidomojo", lat: -7.3567, lng: 112.5724 },
        { name: "Wonokupang", lat: -7.3678, lng: 112.5791 },
        { name: "Tanjungan", lat: -7.3789, lng: 112.5858 },
        { name: "Pagerngumbuk", lat: -7.3890, lng: 112.5925 }
    ],
    "Krian": [
        { name: "Krian", lat: -7.4123, lng: 112.5789 },
        { name: "Barengkrajan", lat: -7.4234, lng: 112.5856 },
        { name: "Kemangsen", lat: -7.4345, lng: 112.5923 },
        { name: "Kacangan", lat: -7.4456, lng: 112.5990 },
        { name: "Mojosantren", lat: -7.4567, lng: 112.6057 },
        { name: "Soko", lat: -7.4678, lng: 112.6124 },
        { name: "Semambung", lat: -7.4789, lng: 112.6191 },
        { name: "Tambak Oso", lat: -7.4890, lng: 112.6258 }
    ],
    "Balongbendo": [
        { name: "Balongbendo", lat: -7.4456, lng: 112.6123 },
        { name: "Gayaman", lat: -7.4567, lng: 112.6190 },
        { name: "Gadingkasri", lat: -7.4678, lng: 112.6257 },
        { name: "Gadingrejo", lat: -7.4789, lng: 112.6324 },
        { name: "Rejeni", lat: -7.4890, lng: 112.6391 },
        { name: "Popoh", lat: -7.4456, lng: 112.6458 },
        { name: "Kedungbanteng", lat: -7.4567, lng: 112.6525 },
        { name: "Putera", lat: -7.4678, lng: 112.6592 }
    ],
    "Tulangan": [
        { name: "Tulangan", lat: -7.4789, lng: 112.6456 },
        { name: "Kepatihan", lat: -7.4890, lng: 112.6523 },
        { name: "Singopadu", lat: -7.4456, lng: 112.6590 },
        { name: "Kendalpecabean", lat: -7.4567, lng: 112.6657 },
        { name: "Kemiri", lat: -7.4678, lng: 112.6724 },
        { name: "Modong", lat: -7.4789, lng: 112.6791 },
        { name: "Kedungboto", lat: -7.4890, lng: 112.6858 },
        { name: "Renokenongo", lat: -7.4456, lng: 112.6925 }
    ],
    "Porong": [
        { name: "Porong", lat: -7.5456, lng: 112.7234 },
        { name: "Lajuk", lat: -7.5567, lng: 112.7301 },
        { name: "Plumbon", lat: -7.5678, lng: 112.7368 },
        { name: "Candipari", lat: -7.5789, lng: 112.7435 },
        { name: "Pamotan", lat: -7.5890, lng: 112.7502 },
        { name: "Siring", lat: -7.5456, lng: 112.7569 },
        { name: "Jatirejo", lat: -7.5567, lng: 112.7636 },
        { name: "Kedungcangkring", lat: -7.5678, lng: 112.7703 }
    ],
    "Jabon": [
        { name: "Jabon", lat: -7.5678, lng: 112.8234 },
        { name: "Kedungbondo", lat: -7.5789, lng: 112.8301 },
        { name: "Permisan", lat: -7.5890, lng: 112.8368 },
        { name: "Lebo", lat: -7.5456, lng: 112.8435 },
        { name: "Segoro Tambak", lat: -7.5567, lng: 112.8502 },
        { name: "Tambak Sumur", lat: -7.5678, lng: 112.8569 },
        { name: "Kupang", lat: -7.5789, lng: 112.8636 },
        { name: "Pepe", lat: -7.5890, lng: 112.8703 }
    ],
    "Prambon": [
        { name: "Prambon", lat: -7.4234, lng: 112.5456 },
        { name: "Tambak Oso", lat: -7.4345, lng: 112.5523 },
        { name: "Candi", lat: -7.4456, lng: 112.5590 },
        { name: "Kebraon", lat: -7.4567, lng: 112.5657 },
        { name: "Kemiri", lat: -7.4678, lng: 112.5724 },
        { name: "Mojosantren", lat: -7.4789, lng: 112.5791 },
        { name: "Kedungbanteng", lat: -7.4890, lng: 112.5858 },
        { name: "Kludan", lat: -7.4456, lng: 112.5925 }
    ],
    "Tarik": [
        { name: "Tarik", lat: -7.3456, lng: 112.5234 },
        { name: "Kedungbendo", lat: -7.3567, lng: 112.5301 },
        { name: "Pelem", lat: -7.3678, lng: 112.5368 },
        { name: "Kedungpandan", lat: -7.3789, lng: 112.5435 },
        { name: "Kramat Jegu", lat: -7.3890, lng: 112.5502 },
        { name: "Kebon Agung", lat: -7.3456, lng: 112.5569 },
        { name: "Gempol", lat: -7.3567, lng: 112.5636 },
        { name: "Kedungwuni", lat: -7.3678, lng: 112.5703 }
    ],
    "Candi": [
        { name: "Candi", lat: -7.5234, lng: 112.6789 },
        { name: "Gilang", lat: -7.5345, lng: 112.6856 },
        { name: "Kedungbendo", lat: -7.5456, lng: 112.6923 },
        { name: "Larangan", lat: -7.5567, lng: 112.6990 },
        { name: "Ngaban", lat: -7.5678, lng: 112.7057 },
        { name: "Sepande", lat: -7.5789, lng: 112.7124 },
        { name: "Sidokepung", lat: -7.5890, lng: 112.7191 },
        { name: "Sumokali", lat: -7.5456, lng: 112.7258 }
    ]
};

// Fungsi untuk menghitung jarak menggunakan rumus Haversine yang lebih akurat
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius bumi dalam kilometer
    const dLat = toRadians(lat2 - lat1);
    const dLon = toRadians(lon2 - lon1);
    
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    // Tambahkan faktor koreksi untuk jalan yang tidak lurus (faktor 1.3)
    return distance * 1.3;
}

function toRadians(degrees) {
    return degrees * (Math.PI / 180);
}

// Fungsi untuk format rupiah
function formatRupiah(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(amount);
}

// Inisialisasi dropdown kecamatan
function initializeDistricts() {
    const fromDistrictSelect = document.getElementById('fromDistrict');
    const toDistrictSelect = document.getElementById('toDistrict');
    
    const districts = Object.keys(sidoarjoData).sort();
    
    districts.forEach(district => {
        const option1 = new Option(district, district);
        const option2 = new Option(district, district);
        fromDistrictSelect.add(option1);
        toDistrictSelect.add(option2);
    });
}

// Fungsi untuk mengisi dropdown desa
function populateVillages(districtSelect, villageSelect) {
    const selectedDistrict = districtSelect.value;
    villageSelect.innerHTML = '<option value="">Pilih Desa</option>';
    
    if (selectedDistrict && sidoarjoData[selectedDistrict]) {
        villageSelect.disabled = false;
        const villages = sidoarjoData[selectedDistrict].sort((a, b) => a.name.localeCompare(b.name));
        villages.forEach(village => {
            const option = new Option(village.name, village.name);
            villageSelect.add(option);
        });
    } else {
        villageSelect.disabled = true;
    }
    
    checkFormComplete();
}

// Fungsi untuk mengecek apakah form lengkap
function checkFormComplete() {
    const fromDistrict = document.getElementById('fromDistrict').value;
    const fromVillage = document.getElementById('fromVillage').value;
    const toDistrict = document.getElementById('toDistrict').value;
    const toVillage = document.getElementById('toVillage').value;
    
    const calculateBtn = document.getElementById('calculateBtn');
    const isComplete = fromDistrict && fromVillage && toDistrict && toVillage;
    
    calculateBtn.disabled = !isComplete;
}

// Fungsi untuk menghitung ongkir
function calculateShipping() {
    const fromDistrict = document.getElementById('fromDistrict').value;
    const fromVillage = document.getElementById('fromVillage').value;
    const toDistrict = document.getElementById('toDistrict').value;
    const toVillage = document.getElementById('toVillage').value;
    
    // Validasi input
    if (!fromDistrict || !fromVillage || !toDistrict || !toVillage) {
        alert('Mohon lengkapi semua pilihan lokasi!');
        return;
    }
    
    // Cari koordinat desa asal dan tujuan
    const fromVillageData = sidoarjoData[fromDistrict].find(v => v.name === fromVillage);
    const toVillageData = sidoarjoData[toDistrict].find(v => v.name === toVillage);
    
    if (!fromVillageData || !toVillageData) {
        alert('Data desa tidak ditemukan!');
        return;
    }
    
    // Hitung jarak
    const distance = calculateDistance(
        fromVillageData.lat, fromVillageData.lng,
        toVillageData.lat, toVillageData.lng
    );
    
    // Kalkulasi harga sesuai rumus yang diminta
    const fuelCost = Math.ceil((distance / 10) * 8000);
    const driverFee = 30000;
    const profit = Math.ceil(distance * 10000);
    const totalPrice = fuelCost + driverFee + profit;
    
    // Tampilkan hasil
    document.getElementById('routeInfo').textContent = 
        `Desa ${fromVillage}, Kec. ${fromDistrict} → Desa ${toVillage}, Kec. ${toDistrict}`;
    document.getElementById('distanceInfo').textContent = `${distance.toFixed(1)} km`;
    document.getElementById('fuelCost').textContent = formatRupiah(fuelCost);
    document.getElementById('profit').textContent = formatRupiah(profit);
    document.getElementById('totalPrice').textContent = formatRupiah(totalPrice);
    
    // Simpan data untuk WhatsApp
    window.orderData = {
        from: `Desa ${fromVillage}, Kec. ${fromDistrict}`,
        to: `Desa ${toVillage}, Kec. ${toDistrict}`,
        distance: distance.toFixed(1),
        price: totalPrice,
        fuelCost: fuelCost,
        profit: profit
    };
    
    // Tampilkan hasil dengan animasi
    const resultElement = document.getElementById('result');
    resultElement.style.display = 'block';
    resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Fungsi untuk mengirim ke WhatsApp
function sendToWhatsApp() {
    if (!window.orderData) {
        alert('Silakan hitung ongkir terlebih dahulu!');
        return;
    }
    
    const message = `Halo AngkutAja, saya ingin memesan jasa angkut:

📍 Dari: ${window.orderData.from}
🎯 Ke: ${window.orderData.to}
📏 Jarak: ${window.orderData.distance} km

💰 Rincian Harga:
• Biaya Solar: ${formatRupiah(window.orderData.fuelCost)}
• Fee Driver: Rp 30.000
• Profit AngkutAja: ${formatRupiah(window.orderData.profit)}
• Total: ${formatRupiah(window.orderData.price)}

Mohon konfirmasi ketersediaan jadwal. Terima kasih! 🙏`;
    
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/6289675892203?text=${encodedMessage}`;
    
    window.open(whatsappUrl, '_blank');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initializeDistricts();
    
    // Event listener untuk dropdown kecamatan asal
    document.getElementById('fromDistrict').addEventListener('change', function() {
        populateVillages(this, document.getElementById('fromVillage'));
        document.getElementById('result').style.display = 'none';
    });
    
    // Event listener untuk dropdown kecamatan tujuan
    document.getElementById('toDistrict').addEventListener('change', function() {
        populateVillages(this, document.getElementById('toVillage'));
        document.getElementById('result').style.display = 'none';
    });
    
    // Event listener untuk dropdown desa
    document.getElementById('fromVillage').addEventListener('change', function() {
        checkFormComplete();
        document.getElementById('result').style.display = 'none';
    });
    
    document.getElementById('toVillage').addEventListener('change', function() {
        checkFormComplete();
        document.getElementById('result').style.display = 'none';
    });
    
    // Event listener untuk tombol hitung
    document.getElementById('calculateBtn').addEventListener('click', calculateShipping);
    
    // Event listener untuk tombol WhatsApp
    document.getElementById('whatsappBtn').addEventListener('click', sendToWhatsApp);
    
    // Smooth scrolling untuk semua link internal
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// Fungsi untuk validasi real-time
function validateForm() {
    const fromDistrict = document.getElementById('fromDistrict').value;
    const fromVillage = document.getElementById('fromVillage').value;
    const toDistrict = document.getElementById('toDistrict').value;
    const toVillage = document.getElementById('toVillage').value;
    
    // Cek apakah asal dan tujuan sama
    if (fromDistrict && fromVillage && toDistrict && toVillage) {
        if (fromDistrict === toDistrict && fromVillage === toVillage) {
            alert('Lokasi asal dan tujuan tidak boleh sama!');
            document.getElementById('toVillage').value = '';
            checkFormComplete();
            return false;
        }
    }
    
    return true;
}

// Update event listener untuk validasi
document.getElementById('toVillage').addEventListener('change', function() {
    if (validateForm()) {
        checkFormComplete();
        document.getElementById('result').style.display = 'none';
    }
});